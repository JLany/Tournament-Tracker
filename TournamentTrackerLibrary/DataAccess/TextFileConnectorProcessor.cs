using System.Configuration;
using TournamentTrackerLibrary.Models;

namespace TournamentTrackerLibrary.DataAccess.TextFileHelpers
{
    public static class TextFileConnectorProcessor
    {
        /// <summary>
        /// Connects the storage directory from <see cref="AppSettings"/> 
        /// to the specified file name
        /// </summary>
        /// <param name="fileName"></param>
        /// <returns></returns>
        public static string FullFilePath(this string fileName)
            => $@"{ConfigurationManager.AppSettings["textFilesDirectory"]}\{fileName}";

        /// <summary>
        /// Loads file contents into a <see cref="List{string}"/> of <see cref="string"/>.
        /// Invoked on a full file path
        /// </summary>
        /// <param name="filePath">Absolute full file path</param>
        /// <returns><see cref="List{T}"/> of <see cref="string"/>: lines in the file</returns>
        public static List<string> LoadFile(this string filePath)
        {
            if (!File.Exists(filePath))
            {
                return new List<string>();
            }

            return File.ReadAllLines(filePath).ToList();
        }

        public static List<PersonModel> ConvertToPersonModels(this List<string> lines)
        {
            var persons = new List<PersonModel>();

            foreach (var line in lines)
            {
                 string[] cols = line.Split(',');

                var p = new PersonModel
                {
                    Id = int.Parse(cols[0]),
                    FirstName = cols[1],
                    LastName = cols[2],
                    EmailAddress = cols[3],
                    PhoneNumber = cols[4]
                };

                persons.Add(p);
            }

            return persons;
        }

        public static List<PrizeModel> ConvertToPrizeModels(this List<string> lines)
        {
            var prizes = new List<PrizeModel>();

            foreach (var line in lines)
            {
                string[] cols = line.Split(',');

                // Here we do not use the `fail tolerant constructor` 
                // because we do not want to have a half ass built model
                // Alternatively, we want this method to crash when something happens
                // this is due to the fact that we read from a file that is generated by
                // the app, so we do expect the data to be right, the opposite is an Exception!
                // Leaving the app in an uncertain state is not the best thing to do with our own hands
                var p = new PrizeModel
                {
                    Id = int.Parse(cols[0]),
                    PlaceNumber = int.Parse(cols[1]),
                    PlaceName = cols[2],
                    PrizeAmount = decimal.Parse(cols[3]),
                    PrizePercentage = int.Parse(cols[4])
                };

                prizes.Add(p);
            }

            return prizes;
        }

        public static List<TeamModel> ConvertToTeamModels(this List<string> lines, string personsFileName)
        {
            // {id,name,list of members' ids}
            // 17,Eagels,14|5|17|18

            var teams = new List<TeamModel>();

            foreach (var line in lines)
            {
                string[] cols = line.Split(',');

                var team = new TeamModel
                {
                    Id = int.Parse(cols[0]),
                    TeamName = cols[1],
                };

                string[] memberIds = cols[2].Split('|');
                var persons = personsFileName.FullFilePath().LoadFile().ConvertToPersonModels();

                foreach (var memberId in memberIds)
                {
                    // get from file of person models
                    PersonModel member = persons.Where(p => p.Id == int.Parse(memberId)).First();
                    team.TeamMembers.Add(member);
                }

                teams.Add(team);
            }

            return teams;
        }

        public static List<TournamentModel> ConvertToTournamentModels(
            this List<string> lines,
            string teamsFileName,
            string personsFileName,
            string prizesFileName)
        {
            // {id,name,entryFee,active,list of teams' ids,list of prizes' ids,list of rounds' ids}
            // {15,CHAMPS,120,1,5|65|41|17|6,7|3|55|23,6^3^12|8^2|8^1

            var tournaments = new List<TournamentModel>();
            var allTeams = teamsFileName.FullFilePath().LoadFile().ConvertToTeamModels(personsFileName);
            var allPrizes = prizesFileName.FullFilePath().LoadFile().ConvertToPrizeModels();

            foreach (var line in lines)
            {
                string[] cols = line.Split(',');

                var tournament = new TournamentModel
                {
                    Id = int.Parse(cols[0]),
                    TournamentName = cols[1],
                    EntryFee = decimal.Parse(cols[2]),
                };

                string[] enteredTeamsIds = cols[4].Split('|');
                foreach (string id in  enteredTeamsIds)
                {
                    tournament.EnteredTeams.Add(allTeams.Where(t => t.Id == int.Parse(id)).First());
                }
                
                string[] tournamentPrizesIds = cols[5].Split('|');
                foreach (string id in  tournamentPrizesIds)
                {
                    tournament.Prizes.Add(allPrizes.Where(t => t.Id == int.Parse(id)).First());
                }

                // TODO - Load rounds into the tournament

                tournaments.Add(tournament);
            }

            return tournaments;
        }

        public static void SaveToModelFile<T>(this List<T> models, string fileName) where T : class
        {
            var lines = new List<string>();

            foreach (var m in models)
            {
                if (null != m)
                {
                    string line = "";

                    foreach (var prop in m.GetType().GetProperties())
                    {
                        line += $"{prop.GetValue(m)},";
                    }

                    line = line.Remove(line.Length - 1);
                    lines.Add(line);
                }
            }

            File.WriteAllLines(fileName.FullFilePath(), lines);
        }

        public static void SaveToTeamModelFile(this List<TeamModel> teams, string fileName)
        {
            var lines = new List<string>();

            foreach (TeamModel t in teams)
            {
                string line = $"{t.Id},{t.TeamName},{t.TeamMembers.ConvertIdsToString('|')}";
                lines.Add(line);
            }

            File.WriteAllLines(fileName.FullFilePath(), lines);
        }

        public static void SaveToTournamentModelFile(this List<TournamentModel> tournaments
            , string fileName)
        {
            // {id,name,entryFee,active,list of teams' ids,list of prizes' ids,list of rounds' ids}
            // {15,CHAMPS,120,1,5|65|41|17|6,7|3|55|23,6^3^12|8^2|8^1

            var lines = new List<string>();

            foreach (TournamentModel t in tournaments)
            {
                string line = $@"{t.Id},{t.TournamentName},{t.EntryFee}
                                 ,{t.EnteredTeams.ConvertIdsToString('|')}
                                 ,{t.Prizes.ConvertIdsToString('|')}
                                 ,{t.Rounds.ConvertIdsToString('|')}";
                lines.Add(line);
            }

            File.WriteAllLines(fileName.FullFilePath(), lines);
        }

        /// <summary>
        /// Convert a list of data models to a string representation of their Ids.
        /// When provided with unexpected input list, wrong output is produced.
        /// <br></br>
        /// Maximum nesting level = 2
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="models"></param>
        /// <param name="delim"></param>
        /// <returns></returns>
        private static string ConvertIdsToString<T>(this List<T> models, char delim) where T : class
        {
            string output = "";
            var idProp = typeof(T).GetProperties().First();

            if (models.Count == 0)
            {
                return "";
            }

            foreach (var model in models)
            {
                if (model is List<T>)
                {
                    output += (model as List<T>)?.ConvertIdsToString('^');
                }
                else
                {
                    output += $"{idProp.GetValue(model)}{delim}";
                }
            }

            output = output.Remove(output.Length - 1);
            return output;
        }
    }
}
